<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Michelle Perkins â€” Executive Job Search OS</title>
  <style>
    :root {
      --navy:   #0a1628;
      --navy2:  #0e1f3d;
      --navy3:  #152747;
      --gold:   #c9a84c;
      --gold2:  #e8c56a;
      --white:  #f0f4ff;
      --gray:   #8899bb;
      --lgray:  #1a2a4a;
      --green:  #2ecc71;
      --amber:  #f39c12;
      --red:    #e74c3c;
      --blue:   #3498db;
      --purple: #9b59b6;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--navy);
      color: var(--white);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }

    /* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .topbar {
      background: var(--navy2);
      border-bottom: 2px solid var(--gold);
      padding: 18px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .topbar-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--white);
      letter-spacing: 0.5px;
    }
    .topbar-title span { color: var(--gold); }
    .topbar-sub {
      font-size: 11px;
      color: var(--gray);
      margin-top: 3px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .topbar-meta {
      text-align: right;
      font-size: 11px;
      color: var(--gray);
    }
    .topbar-meta .as-of { font-size: 12px; color: var(--gold); font-weight: 600; }
    .refresh-btn {
      margin-top: 6px;
      background: var(--gold);
      color: var(--navy);
      border: none;
      padding: 5px 14px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.5px;
    }
    .refresh-btn:hover { background: var(--gold2); }

    /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main { padding: 24px 32px; }

    /* â”€â”€ KPI CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    @media (max-width: 1100px) { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }

    .kpi-card {
      background: var(--navy2);
      border: 1px solid var(--navy3);
      border-top: 3px solid var(--gold);
      border-radius: 6px;
      padding: 16px;
      text-align: center;
    }
    .kpi-card.highlight { border-top-color: var(--green); }
    .kpi-card.warning   { border-top-color: var(--amber); }
    .kpi-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--gray);
      margin-bottom: 8px;
    }
    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--white);
      line-height: 1;
    }
    .kpi-value.gold { color: var(--gold); }
    .kpi-value.green { color: var(--green); }
    .kpi-sub {
      font-size: 10px;
      color: var(--gray);
      margin-top: 4px;
    }

    /* â”€â”€ SECTION HEADERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-header {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--gold);
      font-weight: 700;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--navy3);
      margin-bottom: 14px;
    }

    /* â”€â”€ PIPELINE BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pipeline-section {
      background: var(--navy2);
      border: 1px solid var(--navy3);
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .pipeline-bar {
      display: flex;
      gap: 2px;
      height: 44px;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .pipeline-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: var(--navy);
      transition: opacity 0.2s;
      cursor: default;
      min-width: 8px;
    }
    .pipeline-segment:hover { opacity: 0.85; }
    .pipeline-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--gray);
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* â”€â”€ 2-COLUMN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 20px;
      margin-bottom: 24px;
    }
    @media (max-width: 1000px) { .two-col { grid-template-columns: 1fr; } }

    /* â”€â”€ JOB TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-section {
      background: var(--navy2);
      border: 1px solid var(--navy3);
      border-radius: 6px;
      padding: 20px;
    }
    .table-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-input {
      background: var(--navy3);
      border: 1px solid #2a3d6a;
      color: var(--white);
      padding: 7px 12px;
      border-radius: 4px;
      font-size: 12px;
      width: 200px;
    }
    .filter-select {
      background: var(--navy3);
      border: 1px solid #2a3d6a;
      color: var(--white);
      padding: 7px 10px;
      border-radius: 4px;
      font-size: 12px;
    }
    .filter-input::placeholder { color: var(--gray); }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
    }
    th {
      background: var(--navy3);
      color: var(--gold);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 10px 12px;
      text-align: left;
      cursor: pointer;
      white-space: nowrap;
      user-select: none;
    }
    th:hover { background: #1e3060; }
    th .sort-icon { font-size: 9px; color: var(--gray); margin-left: 3px; }

    tr.job-row { border-bottom: 1px solid var(--navy3); transition: background 0.1s; }
    tr.job-row:hover { background: rgba(201,168,76,0.06); }
    td { padding: 10px 12px; vertical-align: middle; }

    .score-badge {
      display: inline-block;
      width: 36px;
      text-align: center;
      padding: 3px 0;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 700;
    }
    .score-95  { background: #1a4a2e; color: #2ecc71; }
    .score-90  { background: #1a3d4a; color: #1abc9c; }
    .score-85  { background: #1a2f4a; color: #3498db; }
    .score-80  { background: #2d1f4a; color: #9b59b6; }
    .score-75  { background: #3d2a1a; color: #f39c12; }

    .company-name { font-weight: 600; color: var(--white); }
    .job-title    { color: var(--gray); font-size: 11.5px; }
    .comp-val     { color: var(--gold); font-weight: 600; }

    .status-badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10.5px;
      font-weight: 600;
      white-space: nowrap;
    }
    .st-identified        { background: #1a2a3d; color: #5590cc; }
    .st-resume            { background: #1a2d3d; color: #4ab8d8; }
    .st-applied           { background: #1a3029; color: var(--green); }
    .st-recruiter         { background: #2a2a1a; color: #f0c040; }
    .st-interview         { background: #2d1f1a; color: var(--amber); }
    .st-final             { background: #3d1a1a; color: #e08; }
    .st-offer             { background: #1a3a1a; color: #2ecc71; border: 1px solid #2ecc71; }
    .st-rejected, .st-closed { background: #2a1a1a; color: #888; }

    .notes-cell {
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--gray);
      font-size: 11px;
    }
    .link-btn {
      color: var(--gold);
      text-decoration: none;
      font-size: 11px;
      opacity: 0.8;
    }
    .link-btn:hover { opacity: 1; text-decoration: underline; }

    /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar { display: flex; flex-direction: column; gap: 16px; }

    .sidebar-card {
      background: var(--navy2);
      border: 1px solid var(--navy3);
      border-radius: 6px;
      padding: 16px;
    }

    .activity-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--navy3);
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-company { font-weight: 600; font-size: 12px; }
    .activity-title   { color: var(--gray); font-size: 11px; margin: 1px 0; }
    .activity-meta    { display: flex; justify-content: space-between; align-items: center; margin-top: 2px; }

    /* â”€â”€ SCORE DIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dist-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .dist-label { width: 48px; font-size: 11px; color: var(--gray); text-align: right; flex-shrink: 0; }
    .dist-bar-bg { flex: 1; background: var(--navy3); border-radius: 3px; height: 14px; overflow: hidden; }
    .dist-bar-fill { height: 100%; background: var(--gold); border-radius: 3px; transition: width 0.5s; }
    .dist-count { width: 24px; font-size: 11px; color: var(--gray); text-align: right; flex-shrink: 0; }

    /* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--gray);
    }
    .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
    .empty-state p { font-size: 13px; line-height: 1.6; }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--navy2);
      border: 1px solid var(--gold);
      border-radius: 8px;
      padding: 28px;
      width: 560px;
      max-width: 95vw;
      max-height: 85vh;
      overflow-y: auto;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 18px;
    }
    .modal-close {
      float: right;
      background: none;
      border: none;
      color: var(--gray);
      font-size: 20px;
      cursor: pointer;
      line-height: 1;
    }
    .modal-field { margin-bottom: 12px; }
    .modal-field label { display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); margin-bottom: 4px; }
    .modal-field input, .modal-field select, .modal-field textarea {
      width: 100%;
      background: var(--navy3);
      border: 1px solid #2a3d6a;
      color: var(--white);
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 13px;
    }
    .modal-field textarea { height: 80px; resize: vertical; }
    .modal-btn {
      background: var(--gold);
      color: var(--navy);
      border: none;
      padding: 9px 22px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      margin-right: 8px;
    }
    .modal-btn:hover { background: var(--gold2); }
    .modal-btn.secondary {
      background: var(--navy3);
      color: var(--gray);
    }
  </style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div>
    <div class="topbar-title">Michelle Perkins â€” <span>Executive Job Search OS</span></div>
    <div class="topbar-sub">SVP Â· VP Â· Media Strategy Â· Healthcare Â· Pharma Â· Omnichannel</div>
  </div>
  <div class="topbar-meta">
    <div class="as-of" id="as-of">Loadingâ€¦</div>
    <div>Auto-updates on daily run</div>
    <button class="refresh-btn" onclick="loadData()">â†» Refresh</button>
  </div>
</div>

<div class="main">

  <!-- KPI CARDS -->
  <div class="kpi-grid" id="kpi-grid">
    <div class="kpi-card"><div class="kpi-label">Roles Identified</div><div class="kpi-value" id="kpi-total">â€”</div></div>
    <div class="kpi-card"><div class="kpi-label">Applications Sent</div><div class="kpi-value green" id="kpi-applied">â€”</div></div>
    <div class="kpi-card warning"><div class="kpi-label">Active Interviews</div><div class="kpi-value gold" id="kpi-interviews">â€”</div></div>
    <div class="kpi-card highlight"><div class="kpi-label">Offers</div><div class="kpi-value green" id="kpi-offers">â€”</div></div>
    <div class="kpi-card"><div class="kpi-label">Conversion Rate</div><div class="kpi-value" id="kpi-conv">â€”</div><div class="kpi-sub">applied â†’ interview</div></div>
    <div class="kpi-card"><div class="kpi-label">Avg Salary Target</div><div class="kpi-value gold" id="kpi-salary">â€”</div></div>
  </div>

  <!-- PIPELINE BAR -->
  <div class="pipeline-section">
    <div class="section-header">Pipeline</div>
    <div class="pipeline-bar" id="pipeline-bar"></div>
    <div class="pipeline-legend" id="pipeline-legend"></div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="two-col">

    <!-- JOB TABLE -->
    <div class="table-section">
      <div class="section-header">Job Tracker</div>
      <div class="table-controls">
        <input class="filter-input" id="search-input" placeholder="Search company or titleâ€¦" oninput="filterTable()"/>
        <select class="filter-select" id="status-filter" onchange="filterTable()">
          <option value="">All statuses</option>
        </select>
        <select class="filter-select" id="score-filter" onchange="filterTable()">
          <option value="">All scores</option>
          <option value="95">95+</option>
          <option value="90">90+</option>
          <option value="85">85+</option>
          <option value="80">80+</option>
          <option value="75">75+</option>
        </select>
      </div>

      <div id="table-container">
        <div class="empty-state">
          <div class="icon">âš™ï¸</div>
          <p>Loading job tracker dataâ€¦<br>Run <code>python main.py</code> to populate.</p>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">

      <!-- Recent Activity -->
      <div class="sidebar-card">
        <div class="section-header">Recent Activity</div>
        <div id="recent-activity"></div>
      </div>

      <!-- Score Distribution -->
      <div class="sidebar-card">
        <div class="section-header">Score Distribution</div>
        <div id="score-dist"></div>
      </div>

      <!-- Source Breakdown -->
      <div class="sidebar-card">
        <div class="section-header">Source Breakdown</div>
        <div id="source-breakdown"></div>
      </div>

    </div>
  </div>

</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-title">
      <button class="modal-close" onclick="closeModal()">âœ•</button>
      Update Job
    </div>
    <div id="modal-company" style="font-size:15px;font-weight:700;margin-bottom:4px;"></div>
    <div id="modal-title-text" style="color:var(--gray);font-size:13px;margin-bottom:18px;"></div>

    <div class="modal-field">
      <label>Status</label>
      <select id="modal-status"></select>
    </div>
    <div class="modal-field">
      <label>Contact Name</label>
      <input type="text" id="modal-contact-name" placeholder="Recruiter or hiring manager"/>
    </div>
    <div class="modal-field">
      <label>Contact Email</label>
      <input type="email" id="modal-contact-email" placeholder="email@company.com"/>
    </div>
    <div class="modal-field">
      <label>Next Step</label>
      <input type="text" id="modal-next-step" placeholder="e.g. Interview scheduled Mar 5 at 2pm"/>
    </div>
    <div class="modal-field">
      <label>Notes</label>
      <textarea id="modal-notes" placeholder="Anything notable about this role or conversationâ€¦"></textarea>
    </div>
    <div style="margin-top:16px;">
      <button class="modal-btn" onclick="saveModal()">Save Changes</button>
      <button class="modal-btn secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ Data & State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allJobs = [];
let allStatuses = [];
let currentEditId = null;
let sortCol = 'score';
let sortAsc = false;

const PIPELINE_COLORS = {
  'Identified':       '#3a5080',
  'Resume Generated': '#2a6080',
  'Applied':          '#2e7d52',
  'Recruiter Screen': '#7d6b2e',
  'Interview Round 1':'#7d4a2e',
  'Interview Round 2':'#8a2e2e',
  'Final Round':      '#7a1a6a',
  'Offer':            '#1a8a3a',
  'Rejected':         '#333',
  'Closed':           '#222',
};

const STATUS_CSS = {
  'Identified':       'st-identified',
  'Resume Generated': 'st-resume',
  'Applied':          'st-applied',
  'Recruiter Screen': 'st-recruiter',
  'Interview Round 1':'st-interview',
  'Interview Round 2':'st-interview',
  'Final Round':      'st-final',
  'Offer':            'st-offer',
  'Rejected':         'st-rejected',
  'Closed':           'st-closed',
};

// â”€â”€ Load Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  try {
    // Cache-busted fetch
    const resp = await fetch('data.json?t=' + Date.now());
    if (!resp.ok) throw new Error('data.json not found');
    const data = await resp.json();

    allJobs = data.jobs || [];
    allStatuses = data.all_statuses || [];

    renderKPIs(data.kpis || {});
    renderPipeline(data.pipeline || []);
    renderTable();
    renderRecentActivity(data.recent_activity || []);
    renderScoreDist(data.score_distribution || {});
    renderSourceBreakdown(data.source_breakdown || []);
    buildStatusFilter();

    document.getElementById('as-of').textContent = data.kpis?.as_of || '';
  } catch (e) {
    document.getElementById('table-container').innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ”</div>
        <p>No data found. Run the daily pipeline first:<br>
        <code>python main.py</code></p>
      </div>`;
    document.getElementById('as-of').textContent = 'No data yet';
  }
}

// â”€â”€ KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIs(k) {
  document.getElementById('kpi-total').textContent = k.total_identified ?? '0';
  document.getElementById('kpi-applied').textContent = k.applications_sent ?? '0';
  document.getElementById('kpi-interviews').textContent = k.interviews_active ?? '0';
  document.getElementById('kpi-offers').textContent = k.offers ?? '0';
  document.getElementById('kpi-conv').textContent = (k.conversion_rate ?? 0) + '%';
  const sal = k.avg_salary;
  document.getElementById('kpi-salary').textContent = sal ? '$' + sal.toLocaleString() : 'â€”';
}

// â”€â”€ Pipeline Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPipeline(pipeline) {
  const bar = document.getElementById('pipeline-bar');
  const legend = document.getElementById('pipeline-legend');
  bar.innerHTML = '';
  legend.innerHTML = '';

  const total = pipeline.reduce((s, p) => s + p.count, 0) || 1;
  const active = pipeline.filter(p => p.count > 0);

  active.forEach(p => {
    const pct = (p.count / total * 100).toFixed(1);
    const color = PIPELINE_COLORS[p.status] || '#334';
    const seg = document.createElement('div');
    seg.className = 'pipeline-segment';
    seg.style.width = pct + '%';
    seg.style.background = color;
    seg.style.minWidth = p.count > 0 ? '24px' : '0';
    seg.title = `${p.status}: ${p.count}`;
    if (p.count > 0) seg.textContent = p.count;
    bar.appendChild(seg);
  });

  pipeline.forEach(p => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `
      <div class="legend-dot" style="background:${PIPELINE_COLORS[p.status]||'#334'}"></div>
      <span>${p.status} (${p.count})</span>`;
    legend.appendChild(item);
  });
}

// â”€â”€ Job Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  const search = document.getElementById('search-input')?.value.toLowerCase() || '';
  const statusF = document.getElementById('status-filter')?.value || '';
  const scoreF  = parseInt(document.getElementById('score-filter')?.value || '0');

  let jobs = allJobs.filter(j => {
    const matchSearch = !search ||
      j.company.toLowerCase().includes(search) ||
      j.title.toLowerCase().includes(search);
    const matchStatus = !statusF || j.status === statusF;
    const matchScore  = !scoreF || (j.score >= scoreF);
    return matchSearch && matchStatus && matchScore;
  });

  // Sort
  jobs.sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (va === null || va === undefined) va = '';
    if (vb === null || vb === undefined) vb = '';
    if (typeof va === 'number') return sortAsc ? va - vb : vb - va;
    return sortAsc
      ? String(va).localeCompare(String(vb))
      : String(vb).localeCompare(String(va));
  });

  if (jobs.length === 0) {
    document.getElementById('table-container').innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“‹</div>
        <p>No jobs match your filter.<br>Try clearing search or status filter.</p>
      </div>`;
    return;
  }

  const cols = [
    { key: 'score',    label: 'Score' },
    { key: 'company',  label: 'Company' },
    { key: 'title',    label: 'Title' },
    { key: 'compensation_raw', label: 'Salary Est.' },
    { key: 'status',   label: 'Status' },
    { key: 'date_found', label: 'Found' },
    { key: 'date_applied', label: 'Applied' },
    { key: 'notes',    label: 'Notes / Next Step' },
    { key: '_actions', label: '' },
  ];

  const thead = cols.map(c => {
    const icon = c.key === sortCol ? (sortAsc ? 'â–²' : 'â–¼') : 'â‡•';
    const click = c.key !== '_actions' ? `onclick="sortBy('${c.key}')"` : '';
    return `<th ${click}>${c.label} <span class="sort-icon">${c.key !== '_actions' ? icon : ''}</span></th>`;
  }).join('');

  const tbody = jobs.map(j => {
    const scoreClass = j.score >= 95 ? 'score-95' : j.score >= 90 ? 'score-90' :
                       j.score >= 85 ? 'score-85' : j.score >= 80 ? 'score-80' : 'score-75';
    const stClass = STATUS_CSS[j.status] || 'st-identified';
    const comp = j.compensation_raw ? '$' + Number(j.compensation_raw).toLocaleString() : 'â€”';
    const noteText = (j.next_step || j.notes || '').substring(0, 50);
    const link = j.link ? `<a class="link-btn" href="${j.link}" target="_blank">â†— View</a>` : '';

    return `<tr class="job-row" data-id="${j.id}">
      <td><span class="score-badge ${scoreClass}">${j.score}</span></td>
      <td>
        <div class="company-name">${esc(j.company)}</div>
        <div style="font-size:10px;color:var(--gray);margin-top:1px;">${esc(j.source)}</div>
      </td>
      <td>
        <div>${esc(j.title)}</div>
        <div style="font-size:11px;color:var(--gray);">${esc(j.location)}</div>
      </td>
      <td class="comp-val">${comp}</td>
      <td><span class="status-badge ${stClass}">${j.status}</span></td>
      <td style="color:var(--gray);font-size:11px;">${j.date_found||'â€”'}</td>
      <td style="color:var(--gray);font-size:11px;">${j.date_applied||'â€”'}</td>
      <td><div class="notes-cell" title="${esc(j.notes||j.next_step||'')}">${esc(noteText)}</div></td>
      <td>${link} <button onclick="openModal(${j.id})" style="background:none;border:1px solid var(--navy3);color:var(--gray);padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px;margin-left:4px;">Edit</button></td>
    </tr>`;
  }).join('');

  document.getElementById('table-container').innerHTML = `
    <table>
      <thead><tr>${thead}</tr></thead>
      <tbody>${tbody}</tbody>
    </table>
    <div style="margin-top:10px;font-size:11px;color:var(--gray);">
      Showing ${jobs.length} of ${allJobs.length} roles
    </div>`;
}

function sortBy(col) {
  if (sortCol === col) sortAsc = !sortAsc;
  else { sortCol = col; sortAsc = false; }
  renderTable();
}

function filterTable() { renderTable(); }

function buildStatusFilter() {
  const sel = document.getElementById('status-filter');
  if (!sel) return;
  sel.innerHTML = '<option value="">All statuses</option>';
  allStatuses.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = s;
    sel.appendChild(opt);
  });
}

// â”€â”€ Recent Activity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRecentActivity(items) {
  const el = document.getElementById('recent-activity');
  if (!items.length) { el.innerHTML = '<div style="color:var(--gray);font-size:12px;">No activity yet.</div>'; return; }
  el.innerHTML = items.map(i => {
    const stClass = STATUS_CSS[i.status] || 'st-identified';
    return `<div class="activity-item">
      <div class="activity-company">${esc(i.company)}</div>
      <div class="activity-title">${esc(i.title)}</div>
      <div class="activity-meta">
        <span class="status-badge ${stClass}" style="font-size:9px;">${i.status}</span>
        <span style="font-size:10px;color:var(--gray);">${i.updated}</span>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ Score Distribution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderScoreDist(dist) {
  const el = document.getElementById('score-dist');
  const max = Math.max(...Object.values(dist), 1);
  el.innerHTML = Object.entries(dist).map(([range, count]) => `
    <div class="dist-row">
      <div class="dist-label">${range}</div>
      <div class="dist-bar-bg">
        <div class="dist-bar-fill" style="width:${(count/max*100).toFixed(0)}%"></div>
      </div>
      <div class="dist-count">${count}</div>
    </div>`).join('');
}

// â”€â”€ Source Breakdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSourceBreakdown(sources) {
  const el = document.getElementById('source-breakdown');
  const max = Math.max(...sources.map(s => s.count), 1);
  el.innerHTML = sources.map(s => `
    <div class="dist-row">
      <div class="dist-label" style="width:80px;font-size:10px;">${esc(s.source)}</div>
      <div class="dist-bar-bg">
        <div class="dist-bar-fill" style="width:${(s.count/max*100).toFixed(0)}%;background:var(--blue)"></div>
      </div>
      <div class="dist-count">${s.count}</div>
    </div>`).join('');
}

// â”€â”€ Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(jobId) {
  const job = allJobs.find(j => j.id === jobId);
  if (!job) return;
  currentEditId = jobId;

  document.getElementById('modal-company').textContent = job.company;
  document.getElementById('modal-title-text').textContent = job.title;
  document.getElementById('modal-contact-name').value = job.contact_name || '';
  document.getElementById('modal-contact-email').value = job.contact_email || '';
  document.getElementById('modal-next-step').value = job.next_step || '';
  document.getElementById('modal-notes').value = job.notes || '';

  const sel = document.getElementById('modal-status');
  sel.innerHTML = allStatuses.map(s =>
    `<option value="${s}" ${s === job.status ? 'selected' : ''}>${s}</option>`
  ).join('');

  document.getElementById('edit-modal').classList.add('open');
}

function closeModal() {
  document.getElementById('edit-modal').classList.remove('open');
  currentEditId = null;
}

function saveModal() {
  if (!currentEditId) return;
  // Note: Actual persistence requires a backend API call or writing to data.json.
  // For local use, changes are shown in-session and logged to console for manual DB update.
  const updates = {
    id: currentEditId,
    status: document.getElementById('modal-status').value,
    contact_name: document.getElementById('modal-contact-name').value,
    contact_email: document.getElementById('modal-contact-email').value,
    next_step: document.getElementById('modal-next-step').value,
    notes: document.getElementById('modal-notes').value,
  };

  // Update local state
  const job = allJobs.find(j => j.id === currentEditId);
  if (job) Object.assign(job, updates);

  console.log('Job update (run python main.py --update to persist):', JSON.stringify(updates, null, 2));

  closeModal();
  renderTable();
  renderRecentActivity(allJobs.slice(0, 8));

  // Show confirmation
  const banner = document.createElement('div');
  banner.style.cssText = 'position:fixed;bottom:20px;right:20px;background:var(--gold);color:var(--navy);padding:10px 20px;border-radius:6px;font-weight:700;z-index:9999;font-size:13px;';
  banner.textContent = 'Updated (in session). Run main.py to persist to DB.';
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3500);
}

// Click outside modal to close
document.getElementById('edit-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();
// Auto-refresh every 5 minutes when tab is visible
setInterval(() => { if (!document.hidden) loadData(); }, 300000);
</script>
</body>
</html>
