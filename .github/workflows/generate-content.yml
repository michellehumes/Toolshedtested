name: Generate Ultimate Tool Review

on:
  schedule:
    - cron: '0 9,21 * * *'
  workflow_dispatch:
    inputs:
      keyword:
        description: 'Product keyword (leave empty for auto-select)'
        required: false
        type: string
      category:
        description: 'Category'
        required: false
        type: string
        default: 'power-tools'

env:
  AMAZON_TAG: toolshedtested-20

jobs:
  generate:
    runs-on: ubuntu-latest
    name: Generate Ultimate Review
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Get seasonal context
        id: season
        run: |
          MONTH=$(date +%m)
          YEAR=$(date +%Y)
          
          case $MONTH in
            01) SEASON="winter"; THEME="New Year projects"; SALE="Post-holiday clearance sales" ;;
            02) SEASON="winter"; THEME="indoor projects"; SALE="Presidents Day sales coming" ;;
            03) SEASON="spring"; THEME="spring prep"; SALE="Spring sales starting" ;;
            04) SEASON="spring"; THEME="outdoor season"; SALE="Spring sale season" ;;
            05) SEASON="spring"; THEME="outdoor projects"; SALE="Memorial Day sales" ;;
            06) SEASON="summer"; THEME="Father's Day"; SALE="Father's Day deals" ;;
            07) SEASON="summer"; THEME="Prime Day"; SALE="Prime Day deals" ;;
            08) SEASON="summer"; THEME="back to school"; SALE="End of summer clearance" ;;
            09) SEASON="fall"; THEME="fall cleanup"; SALE="Labor Day sales" ;;
            10) SEASON="fall"; THEME="fall projects"; SALE="Early Black Friday previews" ;;
            11) SEASON="fall"; THEME="Black Friday"; SALE="Black Friday and Cyber Monday" ;;
            12) SEASON="winter"; THEME="holiday gifts"; SALE="Holiday sales" ;;
          esac
          
          echo "season=$SEASON" >> $GITHUB_OUTPUT
          echo "theme=$THEME" >> $GITHUB_OUTPUT
          echo "sale=$SALE" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          
      - name: Select keyword
        id: keyword
        run: |
          if [ -n "${{ github.event.inputs.keyword }}" ]; then
            echo "keyword=${{ github.event.inputs.keyword }}" >> $GITHUB_OUTPUT
            echo "category=${{ github.event.inputs.category }}" >> $GITHUB_OUTPUT
          else
            SEASON="${{ steps.season.outputs.season }}"
            if [ -f "content-queue.json" ]; then
              KEYWORD=$(jq -r --arg s "seasonal-$SEASON" '[.queue[] | select(.priority == $s)][0].keyword // empty' content-queue.json)
              if [ -z "$KEYWORD" ]; then
                KEYWORD=$(jq -r '[.queue[] | select(.priority == "high")][0].keyword // empty' content-queue.json)
              fi
              if [ -z "$KEYWORD" ]; then
                KEYWORD=$(jq -r '.queue[0].keyword // empty' content-queue.json)
              fi
              CATEGORY=$(jq -r --arg kw "$KEYWORD" '[.queue[] | select(.keyword == $kw)][0].category // "power-tools"' content-queue.json)
              echo "keyword=$KEYWORD" >> $GITHUB_OUTPUT
              echo "category=$CATEGORY" >> $GITHUB_OUTPUT
            else
              echo "keyword=best cordless drills" >> $GITHUB_OUTPUT
              echo "category=drills" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: Generate ultimate review
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          KEYWORD="${{ steps.keyword.outputs.keyword }}"
          CATEGORY="${{ steps.keyword.outputs.category }}"
          SEASON="${{ steps.season.outputs.season }}"
          THEME="${{ steps.season.outputs.theme }}"
          SALE="${{ steps.season.outputs.sale }}"
          YEAR="${{ steps.season.outputs.year }}"
          SLUG=$(echo "$KEYWORD" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[^a-z0-9-]//g')
          TODAY=$(date +%Y-%m-%d)
          MONTH_NAME=$(date +%B)
          
          PROMPT="You are the lead writer for Toolshed Tested. Write the ULTIMATE comprehensive 3000+ word review for: $KEYWORD

CONTEXT: Today is $TODAY. Season: $SEASON ($THEME). Current sales: $SALE.

FORMAT YOUR RESPONSE EXACTLY LIKE THIS:

---
title: Best $KEYWORD ($YEAR): Expert Tested and Reviewed
slug: $SLUG
category: $CATEGORY
date: $TODAY
author: Toolshed Tested Team
excerpt: Our experts spent 50+ hours testing the top $KEYWORD. Here are our picks for $MONTH_NAME $YEAR.
rating: 4.7
---

## Quick Answer: Our Top Picks for $MONTH_NAME $YEAR

| Rank | Product | Best For | Rating | Price |
|------|---------|----------|--------|-------|
| 1 | [Best Overall Pick] | Best Overall | 4.9/5 | $$$ |
| 2 | [Best Value Pick] | Best Value | 4.7/5 | $$ |
| 3 | [Budget Pick] | Budget Choice | 4.5/5 | $ |

> **$MONTH_NAME $YEAR Update:** $SALE happening now. We have updated our picks with the latest models.

## Why Trust Our Reviews?

At Toolshed Tested, we purchase products ourselves, test for 20+ hours minimum, and compare side-by-side in real conditions.

## The 7 Best $KEYWORD of $YEAR

### 1. [REAL PRODUCT NAME WITH MODEL NUMBER] - Best Overall
**Rating: 4.9/5**

[Write 2-3 paragraphs about why this is the best overall. Include specific features, test results, and real specs.]

**Key Specs:**
- [Spec 1]: [Value]
- [Spec 2]: [Value]
- [Spec 3]: [Value]

**Pros:**
- [Specific pro with detail]
- [Specific pro with detail]
- [Specific pro with detail]

**Cons:**
- [Honest con]
- [Honest con]

**Where to Buy:**
- [Check Price on Amazon](https://www.amazon.com/s?k=PRODUCT+NAME+HERE&tag=toolshedtested-20)
- [Check Price at Home Depot](https://www.homedepot.com/s/PRODUCT+NAME)
- [Check Price at Lowes](https://www.lowes.com/search?searchTerm=PRODUCT+NAME)

---

### 2. [REAL PRODUCT NAME] - Best Value
[Same detailed format as above]

---

### 3. [REAL PRODUCT NAME] - Budget Pick (Under \$X)
[Same detailed format]

---

### 4. [REAL PRODUCT NAME] - Best for [Specific Use]
[Same detailed format]

---

### 5. [REAL PRODUCT NAME] - Best for [Another Use]
[Same detailed format]

---

### 6. [REAL PRODUCT NAME] - Runner Up
[Same detailed format]

---

### 7. [REAL PRODUCT NAME] - Also Consider
[Same detailed format]

---

## Complete Comparison Chart

| Product | Rating | Best For | Power | Weight | Price |
|---------|--------|----------|-------|--------|-------|
| [Product 1] | 4.9 | Overall | [X] | [X] | $$$ |
| [Product 2] | 4.7 | Value | [X] | [X] | $$ |
| [Product 3] | 4.5 | Budget | [X] | [X] | $ |
| [Product 4] | 4.6 | [Use] | [X] | [X] | $$ |
| [Product 5] | 4.4 | [Use] | [X] | [X] | $$ |
| [Product 6] | 4.3 | [Use] | [X] | [X] | $$ |
| [Product 7] | 4.2 | [Use] | [X] | [X] | $ |

## Buyers Guide: How to Choose

### Key Features to Consider

**1. [Most Important Feature]**
[2-3 paragraphs explaining what to look for]

**2. [Second Feature]**
[2-3 paragraphs]

**3. [Third Feature]**
[2-3 paragraphs]

### Price Ranges

| Budget | Price | What You Get |
|--------|-------|--------------|
| Budget | \$X-\$X | Basic features for occasional use |
| Mid-Range | \$X-\$X | Good balance of features and quality |
| Premium | \$X+ | Professional-grade performance |

## When to Buy: Best Times for Deals

1. **Black Friday/Cyber Monday** (November) - 30-50% off
2. **Prime Day** (July) - 20-40% off
3. **Memorial Day** (May) - 15-30% off
4. **Fathers Day** (June) - 15-25% off

## Frequently Asked Questions

### [Most common question about $KEYWORD]?
[Detailed 2-3 sentence answer]

### [Second common question]?
[Detailed answer]

### [Third question]?
[Detailed answer]

### [Fourth question]?
[Detailed answer]

### [Fifth question]?
[Detailed answer]

## Final Verdict

[2-3 paragraphs with clear recommendations]

**For most people:** We recommend [Best Overall] because [reasons].

**On a budget:** The [Budget Pick] offers [value].

**For professionals:** Go with [Premium Pick] for [reasons].

---

*Last updated: $TODAY. As an Amazon Associate and affiliate partner, we earn from qualifying purchases.*

---

CRITICAL INSTRUCTIONS:
1. Use REAL product names with model numbers (e.g., DeWalt DCD999B not just DeWalt Drill)
2. Every Amazon link must use: https://www.amazon.com/s?k=Brand+Model+Name&tag=toolshedtested-20
3. Include actual realistic specifications
4. Write at least 3000 words total
5. Make this THE definitive guide for $KEYWORD"

          # Escape the prompt for JSON
          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 8000,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $PROMPT_JSON
              }]
            }")
          
          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')
          
          if [ -z "$CONTENT" ] || [ "$CONTENT" == "null" ]; then
            echo "Error generating content"
            echo "$RESPONSE"
            exit 1
          fi
          
          mkdir -p posts
          echo "$CONTENT" > "posts/$SLUG.md"
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "Generated: $KEYWORD"
          
      - name: Remove used keyword
        run: |
          KEYWORD="${{ steps.keyword.outputs.keyword }}"
          if [ -f "content-queue.json" ]; then
            jq --arg kw "$KEYWORD" '.queue = [.queue[] | select(.keyword != $kw)]' content-queue.json > tmp.json
            mv tmp.json content-queue.json
          fi
          
      - name: Commit and Push
        run: |
          git config --global user.name 'Toolshed Tested Bot'
          git config --global user.email 'bot@toolshedtested.com'
          git add .
          git commit -m "New review: ${{ steps.keyword.outputs.keyword }}" || echo "No changes"
          git push origin main
