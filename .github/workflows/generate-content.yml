name: Generate and Publish to WordPress

on:
  schedule:
    - cron: '0 9,21 * * *'
  workflow_dispatch:
    inputs:
      keyword:
        description: 'Product keyword (leave empty for auto-select)'
        required: false
        type: string

env:
  AMAZON_TAG: toolshedtested-20

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    name: Generate Review and Publish to WordPress
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get seasonal context
        id: season
        run: |
          MONTH=$(date +%m)
          YEAR=$(date +%Y)
          case $MONTH in
            01) SEASON="winter"; THEME="New Year projects"; SALE="Post-holiday clearance" ;;
            02) SEASON="winter"; THEME="indoor projects"; SALE="Presidents Day sales" ;;
            03) SEASON="spring"; THEME="spring prep"; SALE="Spring sales" ;;
            04) SEASON="spring"; THEME="outdoor season"; SALE="Spring sales" ;;
            05) SEASON="spring"; THEME="outdoor projects"; SALE="Memorial Day sales" ;;
            06) SEASON="summer"; THEME="Fathers Day"; SALE="Fathers Day deals" ;;
            07) SEASON="summer"; THEME="Prime Day"; SALE="Prime Day deals" ;;
            08) SEASON="summer"; THEME="back to school"; SALE="Summer clearance" ;;
            09) SEASON="fall"; THEME="fall cleanup"; SALE="Labor Day sales" ;;
            10) SEASON="fall"; THEME="fall projects"; SALE="Early Black Friday" ;;
            11) SEASON="fall"; THEME="Black Friday"; SALE="Black Friday Cyber Monday" ;;
            12) SEASON="winter"; THEME="holiday gifts"; SALE="Holiday sales" ;;
          esac
          echo "season=$SEASON" >> $GITHUB_OUTPUT
          echo "theme=$THEME" >> $GITHUB_OUTPUT
          echo "sale=$SALE" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT

      - name: Select keyword
        id: keyword
        run: |
          if [ -n "${{ github.event.inputs.keyword }}" ]; then
            echo "keyword=${{ github.event.inputs.keyword }}" >> $GITHUB_OUTPUT
          else
            SEASON="${{ steps.season.outputs.season }}"
            if [ -f "content-queue.json" ]; then
              KEYWORD=$(jq -r ".queue[0].keyword // empty" content-queue.json)
              if [ -z "$KEYWORD" ]; then
                KEYWORD="cordless power tools"
              fi
              echo "keyword=$KEYWORD" >> $GITHUB_OUTPUT
            else
              echo "keyword=cordless power tools" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate review with Claude
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          KEYWORD="${{ steps.keyword.outputs.keyword }}"
          SEASON="${{ steps.season.outputs.season }}"
          THEME="${{ steps.season.outputs.theme }}"
          SALE="${{ steps.season.outputs.sale }}"
          YEAR="${{ steps.season.outputs.year }}"
          MONTH_NAME=$(date +%B)

          PROMPT="Write a comprehensive 2500+ word product review article in HTML format for an affiliate marketing site.

          STRUCTURE (use these exact sections):
          1. Introduction paragraph with hook about $THEME and $SALE
          2. Quick comparison table of top 5 picks
          3. Individual product reviews (5-7 products)
          4. Buying guide section
          5. FAQ section (5+ questions)
          6. Conclusion with final recommendation

          HTML STYLING REQUIREMENTS - USE THESE EXACT CSS CLASSES:

          FOR AFFILIATE DISCLOSURE (at top):
          <div class=\"affiliate-disclosure\">
          <strong>Affiliate Disclosure:</strong> We earn commissions from qualifying purchases. This doesn't affect our reviews or recommendations.
          </div>

          FOR COMPARISON TABLE:
          <div class=\"comparison-table-wrapper\">
          <table class=\"comparison-table\">
          <thead><tr><th>Product</th><th>Best For</th><th>Rating</th><th>Price</th><th></th></tr></thead>
          <tbody>
          <tr><td class=\"product-cell\"><span class=\"product-name\">Product Name</span></td><td>Use case</td><td class=\"rating-cell\">⭐⭐⭐⭐⭐ 4.8</td><td class=\"price-cell\">\$XXX</td><td class=\"cta-cell\"><a href=\"URL\" class=\"tst-btn tst-btn-amazon\">Check Price</a></td></tr>
          </tbody></table></div>

          FOR EACH PRODUCT REVIEW BOX:
          <div class=\"review-box\">
          <div class=\"review-box-header\">
          <div class=\"review-box-image\"><img src=\"https://via.placeholder.com/200x200?text=Product\" alt=\"Product Name\"></div>
          <div class=\"review-box-info\">
          <span class=\"badge badge-bestseller\">Best Overall</span> (or badge-editors-choice or badge-budget-pick)
          <h3 class=\"review-box-title\">Product Name - Model Number</h3>
          <div class=\"review-box-rating\"><span class=\"rating-stars\">⭐⭐⭐⭐⭐</span><span class=\"rating-score\">4.8/5</span></div>
          <div class=\"review-box-price\">\$XXX</div>
          <div class=\"review-box-cta\">
          <a href=\"https://www.amazon.com/s?k=Product+Name&tag=toolshedtested-20\" class=\"tst-btn tst-btn-amazon\" target=\"_blank\" rel=\"nofollow noopener\">Check Price on Amazon</a>
          </div></div></div>
          <p>Detailed product description...</p>
          <div class=\"pros-cons\">
          <div class=\"pros-list\"><h4>Pros</h4><ul><li>Pro 1</li><li>Pro 2</li></ul></div>
          <div class=\"cons-list\"><h4>Cons</h4><ul><li>Con 1</li><li>Con 2</li></ul></div>
          </div></div>

          FOR FAQ SECTION:
          <div class=\"faq-section\"><h2>Frequently Asked Questions</h2>
          <div class=\"faq-item\"><div class=\"faq-question\">Question here?</div><div class=\"faq-answer\"><div class=\"faq-answer-inner\">Answer here...</div></div></div>
          </div>

          FOR FINAL CTA:
          <div class=\"final-cta\">
          <h3>Ready to Buy?</h3>
          <p>Our top pick is [Product Name] for most users.</p>
          <a href=\"URL\" class=\"tst-btn tst-btn-cta\" target=\"_blank\" rel=\"nofollow noopener\">Get the Best Price on Amazon →</a>
          </div>

          IMPORTANT RULES:
          - Use REAL product names with actual model numbers (DeWalt DCD771C2, Milwaukee 2804-20, etc.)
          - All Amazon links: https://www.amazon.com/s?k=Product+Name+Model&tag=toolshedtested-20
          - Include realistic prices based on current market
          - Badge types: badge-bestseller (top pick), badge-editors-choice (premium), badge-budget-pick (value)
          - Make content scannable with clear headings
          - Write naturally, avoid robotic/AI-sounding text
          - Focus on helping buyers make decisions

          Return ONLY valid HTML content. No markdown, no code blocks, no backticks.

          TOPIC: Best $KEYWORD
          DATE: $MONTH_NAME $YEAR
          SEASON: $SEASON ($THEME)
          CURRENT DEALS: $SALE"

          PROMPT_JSON=$(echo "$PROMPT" | jq -Rs .)

          echo "Generating content for: $KEYWORD"

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{\"model\": \"claude-3-haiku-20240307\", \"max_tokens\": 4096, \"messages\": [{\"role\": \"user\", \"content\": $PROMPT_JSON}]}")

          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')

          if [ -z "$CONTENT" ] || [ "$CONTENT" == "null" ]; then
            echo "Error generating content"
            echo "$RESPONSE"
            exit 1
          fi

          echo "$CONTENT" > /tmp/article_content.html
          TITLE="Best $KEYWORD $YEAR: Expert Tested & Reviewed"
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "Content generated successfully"

      - name: Publish to WordPress
        env:
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          WP_SITE_URL: ${{ secrets.WP_SITE_URL }}
        run: |
          set -e
          
          KEYWORD="${{ steps.keyword.outputs.keyword }}"
          TITLE="${{ steps.generate.outputs.title }}"
          CONTENT=$(cat /tmp/article_content.html)
          
          SLUG=$(echo "$KEYWORD" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[^a-z0-9-]//g')
          SLUG="best-$SLUG"
          
          echo "Publishing: $TITLE"
          echo "Slug: $SLUG"
          
          AUTH=$(echo -n "$WP_USERNAME:$WP_PASSWORD" | base64)
          
          sudo apt-get update -qq && sudo apt-get install -y -qq ca-certificates > /dev/null 2>&1 || true
          
          echo "Checking for existing post..."
          EXISTING=$(curl -sS --insecure --retry 3 --retry-delay 2 --connect-timeout 30 "$WP_SITE_URL/wp-json/wp/v2/posts?slug=$SLUG" 2>&1) || EXISTING="[]"
          
          if echo "$EXISTING" | jq -e '.[0].id' > /dev/null 2>&1; then
            EXISTING_ID=$(echo "$EXISTING" | jq -r '.[0].id')
            echo "Updating existing post ID: $EXISTING_ID"
            METHOD="PUT"
            ENDPOINT="$WP_SITE_URL/wp-json/wp/v2/posts/$EXISTING_ID"
          else
            echo "Creating new post"
            METHOD="POST"
            ENDPOINT="$WP_SITE_URL/wp-json/wp/v2/posts"
          fi
          
          PAYLOAD=$(jq -n --arg title "$TITLE" --arg content "$CONTENT" --arg slug "$SLUG" --arg status "publish" '{title: $title, content: $content, slug: $slug, status: $status}')
          
          echo "Payload size: $(echo "$PAYLOAD" | wc -c) bytes"
          
          echo "Sending to WordPress..."
          HTTP_CODE=$(curl -sS --insecure -w "%{http_code}" -o /tmp/wp_response.json --retry 3 --retry-delay 5 --connect-timeout 30 --max-time 120 -X "$METHOD" "$ENDPOINT" -H "Authorization: Basic $AUTH" -H "Content-Type: application/json" -d "$PAYLOAD") || {
            echo "Curl failed"
            cat /tmp/wp_response.json 2>/dev/null || echo "No response"
            exit 1
          }
          
          echo "HTTP Response Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            RESPONSE=$(cat /tmp/wp_response.json)
            POST_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
            POST_LINK=$(echo "$RESPONSE" | jq -r '.link // empty')
            
            if [ -n "$POST_ID" ] && [ "$POST_ID" != "null" ]; then
              echo ""
              echo "Successfully published!"
              echo "Post ID: $POST_ID"
              echo "URL: $POST_LINK"
            else
              echo "Response missing post ID"
              cat /tmp/wp_response.json | head -c 1000
              exit 1
            fi
          else
            echo "WordPress API error (HTTP $HTTP_CODE):"
            cat /tmp/wp_response.json | head -c 1000
            exit 1
          fi

      - name: Remove used keyword from queue
        if: success() && github.event.inputs.keyword == ''
        run: |
          if [ -f "content-queue.json" ]; then
            USED_KEYWORD=$(jq -r '.queue[0].keyword' content-queue.json)
            jq 'del(.queue[0])' content-queue.json > temp.json && mv temp.json content-queue.json
            
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add content-queue.json
            git commit -m "Remove published keyword: $USED_KEYWORD" || echo "No changes"
            git push || echo "Push failed"
          fi
