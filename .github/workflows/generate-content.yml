name: Generate Ultimate Tool Review

on:
  schedule:
    - cron: '0 9,21 * * *'
  workflow_dispatch:
    inputs:
      keyword:
        description: 'Product keyword (leave empty for auto-select)'
        required: false
        type: string
      category:
        description: 'Category'
        required: false
        type: string
        default: 'power-tools'

env:
  AMAZON_TAG: toolshedtested-20

jobs:
  generate:
    runs-on: ubuntu-latest
    name: Generate Ultimate Review
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Get seasonal context
        id: season
        run: |
          MONTH=$(date +%m)
          YEAR=$(date +%Y)
          case $MONTH in
            01) SEASON="winter"; THEME="New Year projects"; SALE="Post-holiday clearance" ;;
            02) SEASON="winter"; THEME="indoor projects"; SALE="Presidents Day sales" ;;
            03) SEASON="spring"; THEME="spring prep"; SALE="Spring sales" ;;
            04) SEASON="spring"; THEME="outdoor season"; SALE="Spring sales" ;;
            05) SEASON="spring"; THEME="outdoor projects"; SALE="Memorial Day sales" ;;
            06) SEASON="summer"; THEME="Fathers Day"; SALE="Fathers Day deals" ;;
            07) SEASON="summer"; THEME="Prime Day"; SALE="Prime Day deals" ;;
            08) SEASON="summer"; THEME="back to school"; SALE="Summer clearance" ;;
            09) SEASON="fall"; THEME="fall cleanup"; SALE="Labor Day sales" ;;
            10) SEASON="fall"; THEME="fall projects"; SALE="Early Black Friday" ;;
            11) SEASON="fall"; THEME="Black Friday"; SALE="Black Friday Cyber Monday" ;;
            12) SEASON="winter"; THEME="holiday gifts"; SALE="Holiday sales" ;;
          esac
          echo "season=$SEASON" >> $GITHUB_OUTPUT
          echo "theme=$THEME" >> $GITHUB_OUTPUT
          echo "sale=$SALE" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          
      - name: Select keyword
        id: keyword
        run: |
          if [ -n "${{ github.event.inputs.keyword }}" ]; then
            echo "keyword=${{ github.event.inputs.keyword }}" >> $GITHUB_OUTPUT
            echo "category=${{ github.event.inputs.category }}" >> $GITHUB_OUTPUT
          else
            SEASON="${{ steps.season.outputs.season }}"
            if [ -f "content-queue.json" ]; then
              KEYWORD=$(jq -r --arg s "seasonal-$SEASON" '[.queue[] | select(.priority == $s)][0].keyword // empty' content-queue.json)
              if [ -z "$KEYWORD" ]; then
                KEYWORD=$(jq -r '[.queue[] | select(.priority == "high")][0].keyword // empty' content-queue.json)
              fi
              if [ -z "$KEYWORD" ]; then
                KEYWORD=$(jq -r '.queue[0].keyword // empty' content-queue.json)
              fi
              CATEGORY=$(jq -r --arg kw "$KEYWORD" '[.queue[] | select(.keyword == $kw)][0].category // "power-tools"' content-queue.json)
              echo "keyword=$KEYWORD" >> $GITHUB_OUTPUT
              echo "category=$CATEGORY" >> $GITHUB_OUTPUT
            else
              echo "keyword=best cordless drills" >> $GITHUB_OUTPUT
              echo "category=drills" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: Generate ultimate review
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          KEYWORD="${{ steps.keyword.outputs.keyword }}"
          CATEGORY="${{ steps.keyword.outputs.category }}"
          SEASON="${{ steps.season.outputs.season }}"
          THEME="${{ steps.season.outputs.theme }}"
          SALE="${{ steps.season.outputs.sale }}"
          YEAR="${{ steps.season.outputs.year }}"
          SLUG=$(echo "$KEYWORD" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g' | sed 's/[^a-z0-9-]//g')
          TODAY=$(date +%Y-%m-%d)
          MONTH_NAME=$(date +%B)
          
          cat > /tmp/prompt.txt << 'PROMPTEOF'
          You are the lead writer for Toolshed Tested, the most trusted tool review site. Write a comprehensive 3000+ word product review.
          
          REQUIREMENTS:
          1. Use REAL product names with model numbers (e.g., DeWalt DCD999B, Milwaukee 2853-20)
          2. Include 7 product recommendations organized as: Best Overall, Best Value, Budget Pick, plus 4 more for specific uses
          3. Every product needs: star rating, key specs table, pros, cons, and affiliate links
          4. Amazon links MUST use this format: https://www.amazon.com/s?k=Product+Name+Here&tag=toolshedtested-20
          5. Also include Home Depot and Lowes links for each product
          6. Include a comparison table, buyers guide, FAQ section, and final verdict
          7. Reference current season and sales when relevant
          
          FORMAT: Start with YAML frontmatter (title, slug, category, date, author, excerpt, rating), then the full article in markdown.
          PROMPTEOF
          
          FULL_PROMPT=$(cat /tmp/prompt.txt)
          FULL_PROMPT="$FULL_PROMPT

          TOPIC: $KEYWORD
          CATEGORY: $CATEGORY  
          DATE: $TODAY
          MONTH: $MONTH_NAME
          YEAR: $YEAR
          SEASON: $SEASON ($THEME)
          CURRENT SALES: $SALE
          SLUG: $SLUG
          AMAZON TAG: toolshedtested-20"
          
          PROMPT_JSON=$(echo "$FULL_PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 8000,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $PROMPT_JSON
              }]
            }")
          
          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')
          
          if [ -z "$CONTENT" ] || [ "$CONTENT" == "null" ]; then
            echo "Error generating content"
            echo "$RESPONSE"
            exit 1
          fi
          
          mkdir -p posts
          echo "$CONTENT" > "posts/$SLUG.md"
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "Generated: $KEYWORD"
          
      - name: Remove used keyword
        run: |
          KEYWORD="${{ steps.keyword.outputs.keyword }}"
          if [ -f "content-queue.json" ]; then
            jq --arg kw "$KEYWORD" '.queue = [.queue[] | select(.keyword != $kw)]' content-queue.json > tmp.json
            mv tmp.json content-queue.json
          fi
          
      - name: Commit and Push
        run: |
          git config --global user.name 'Toolshed Tested Bot'
          git config --global user.email 'bot@toolshedtested.com'
          git add .
          git commit -m "New review: ${{ steps.keyword.outputs.keyword }}" || echo "No changes"
          git push origin main
